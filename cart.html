<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Saved Designs – Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .design-buttons { display:flex; gap:.6rem; }
    .design-buttons button { padding:.4rem .8rem; font-weight:bold; border-radius:4px; cursor:pointer; }
    .saved-item { padding:.6rem 0; border-bottom:1px solid #eee; }
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul>
      <li><span id="userNameDisplay" style="font-weight:bold; margin-left:10px; color:yellow;"></span><a href="grillz.html">  Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="#" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>
</header>

<main>
  <h1>Your Saved Grillz</h1>
  <div id="saved-designs"></div>
  <h2>Total: $<span id="totalPrice">0.00</span></h2>
  <div style="margin-top:2rem; display:flex; gap:1rem;">
    <button onclick="location.href='grillz.html'">Continue Shopping</button>
    <button onclick="location.href='contact.html'">Send Message</button>
  </div>
</main>

<script>
  const API_BASE = "https://lailastreasures.onrender.com";

  (function headerName(){
    const n = localStorage.getItem("userName");
    if (n) document.getElementById("userNameDisplay").textContent = `(${n})`;
  })();

  document.getElementById("logoutBtn").addEventListener("click", async (e) => {
    e.preventDefault();
    try { await fetch(`${API_BASE}/api/users/logout`, { method:'POST', credentials:'include' }); } catch {}
    localStorage.removeItem("userName");
    location.href = "login.html";
  });

  function normalizeImg(src) {
    if (!src) return "";
    if (src.startsWith("http") || src.startsWith("assets/")) return src;
    return "assets/images/" + src;
  }

  async function loadCart() {
    const container = document.getElementById("saved-designs");
    container.innerHTML = "Loading…";
    document.getElementById("totalPrice").textContent = "0.00";

    try {
      const me = await fetch(`${API_BASE}/api/users/me`, { credentials:'include' })
                    .then(r=>r.json()).catch(()=>({loggedIn:false}));
      if (!me.loggedIn) { container.innerHTML = "<p>Please log in to see your cart.</p>"; return; }

      const res = await fetch(`${API_BASE}/api/cart`, { credentials:'include' });
      if (!res.ok) throw new Error(`Failed to load cart (${res.status})`);
      const items = await res.json();
      renderCart(items);
    } catch (err) {
      container.innerHTML = `<p style="color:#b00020">Error: ${err.message}</p>`;
    }
  }

  function renderCart(items) {
    const container = document.getElementById("saved-designs");
    container.innerHTML = "";

    if (!items?.length) {
      container.innerHTML = "<p>No designs saved yet.</p>";
      document.getElementById("totalPrice").textContent = "0.00";
      return;
    }

    let total = 0;

    items.forEach((item) => {
      const price = Number(item.price) || 0;
      total += price;

      const topList = Array.isArray(item.selectedTop) ? item.selectedTop.join(", ") : "";
      const bottomList = Array.isArray(item.selectedBottom) ? item.selectedBottom.join(", ") : "";

      const div = document.createElement("div");
      div.className = "saved-item";
      div.innerHTML = `
        <div style="display:flex; align-items:center; gap:1rem;">
          <img src="${normalizeImg(item.img)}" alt="${item.name || ''}" style="width:60px; height:40px; object-fit:cover; border-radius:4px;">
          <span style="flex:1;">
            <strong>${item.name || ''}</strong><br>
            Material: ${item.material || "Not specified"}<br>
            Top Teeth: ${item.top || 0} [${topList || "-"}]<br>
            Bottom Teeth: ${item.bottom || 0} [${bottomList || "-"}]<br>
            Price: $${price.toFixed(2)}
          </span>
          <div class="design-buttons">
            <button class="remove-btn" data-id="${item._id}">Remove</button>
          </div>
        </div>
      `;
      container.appendChild(div);
    });

    container.querySelectorAll(".remove-btn").forEach(btn => {
      btn.addEventListener("click", () => removeDesign(btn.dataset.id));
    });

    document.getElementById("totalPrice").textContent = total.toFixed(2);
  }

  async function removeDesign(id) {
    if (!id) return;
    if (!confirm("Remove this design?")) return;
    try {
      const res = await fetch(`${API_BASE}/api/cart/${id}`, {
        method:'DELETE',
        credentials:'include'
      });
      if (!res.ok) throw new Error(`Delete failed (${res.status})`);
      await loadCart();
    } catch (err) {
      alert(err.message);
    }
  }

  document.addEventListener("DOMContentLoaded", loadCart);
</script>
</body>
</html>