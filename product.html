<!DOCTYPE html>
<html>
<head>
  <title>Product - Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .product-container { display:flex; gap:3rem; margin-top:2rem; align-items:flex-start; }
    .product-image { flex:1; max-width:400px; }
    .product-details { flex:2; }
    .price { font-size:1.3rem; margin-top:1rem; font-weight:bold; }
    .discount { color:green; font-weight:bold; }
    .tooth { width:28px; height:40px; background:#fff; border:1px solid #aaa; border-radius:6px; cursor:pointer; transition:.3s; }
    .tooth.selected { background:gold; border-color:#d4af37; }
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul>
      <li><span id="userNameDisplay" style="font-weight:bold; margin-left:10px; color:yellow;"></span><a href="grillz.html">  Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="#" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>
</header>

<main style="padding:2rem;">
  <div class="product-container">
    <div class="product-image">
      <img id="productImage" src="" alt="Grill" style="width:100%; border-radius:8px;">
    </div>
    <div class="product-details">
      <h2 id="productName">Loading...</h2>
      <div><strong>Material:</strong> <span id="materialLabel">Loading...</span></div><br>

      <div id="goldMaterialSelectContainer" style="display:none;">
        <label id="goldMaterialLabel">Select Gold Type:</label><br>
        <select id="goldMaterialSelect"></select><br><br>
      </div>

      <label for="topTeeth">Top Teeth:</label>
      <input type="number" id="topTeeth" min="0" value="0" readonly><br><br>

      <label for="bottomTeeth">Bottom Teeth:</label>
      <input type="number" id="bottomTeeth" min="0" value="0" readonly><br><br>

      <div class="price">Total Price: $<span id="priceValue">0.00</span></div>
      <div id="discountNote" class="discount"></div><br>

      <button id="saveBtn">Save Design</button>
    </div>
  </div>

  <div style="margin-top:2rem;">
    <h3>Select Your Teeth:</h3>
    <div id="teethDiagram" style="display:flex; flex-direction:column; align-items:center; gap:1rem;">
      <div id="topRow" style="display:flex; gap:0.3rem;"></div>
      <div id="bottomRow" style="display:flex; gap:0.3rem;"></div>
    </div>
  </div>
</main>

<script>
  const BASE_API = "https://lailastreasures.onrender.com";

  // Small header nicety
  (function headerName(){
    const n = localStorage.getItem("userName");
    if (n) document.getElementById("userNameDisplay").textContent = `(${n})`;
  })();

  document.getElementById('logoutBtn').addEventListener('click', async (e) => {
    e.preventDefault();
    try { await fetch(`${BASE_API}/api/users/logout`, { method:'POST', credentials:'include' }); } catch {}
    localStorage.removeItem('userName');
    location.href = "login.html";
  });

  // URL / state
  const params = new URLSearchParams(location.search);
  const productName = params.get("name") || "Grill";
  const urlMaterial = params.get("material");
  let material = urlMaterial || "10K Gold";

  let selectedTopTeeth = [1]; // preselect 1
  let selectedBottomTeeth = [];

  const imgEl = document.getElementById("productImage");
  const nameEl = document.getElementById("productName");
  const materialLabelEl = document.getElementById("materialLabel");
  const priceEl = document.getElementById("priceValue");
  const discountNoteEl = document.getElementById("discountNote");
  const topCountEl = document.getElementById("topTeeth");
  const bottomCountEl = document.getElementById("bottomTeeth");
  const goldWrap = document.getElementById("goldMaterialSelectContainer");
  const goldLabel = document.getElementById("goldMaterialLabel");
  const goldSelect = document.getElementById("goldMaterialSelect");

  nameEl.textContent = productName;

  function buildTeeth(rowId, prefix) {
    const row = document.getElementById(rowId);
    for (let i = 1; i <= 10; i++) {
      const tooth = document.createElement("div");
      tooth.className = "tooth";
      tooth.dataset.row = prefix;
      tooth.dataset.index = i;
      tooth.addEventListener("click", () => toggleTooth(tooth));
      row.appendChild(tooth);
    }
  }
  buildTeeth("topRow", "top");
  buildTeeth("bottomRow", "bottom");
  document.querySelector(".tooth[data-row='top'][data-index='1']").classList.add("selected");

  function toggleTooth(el) {
    const list = el.dataset.row === "top" ? selectedTopTeeth : selectedBottomTeeth;
    const idx = list.indexOf(+el.dataset.index);
    if (idx > -1) { list.splice(idx,1); el.classList.remove("selected"); }
    else { list.push(+el.dataset.index); el.classList.add("selected"); }
    updatePrice();
  }

  async function fetchProductBy(name, mat) {
    try {
      const qs = new URLSearchParams({ name, material: mat });
      const res = await fetch(`${BASE_API}/api/products?${qs}`, { credentials:'omit' });
      if (!res.ok) return null;
      const items = await res.json();
      return items?.[0] || null;
    } catch { return null; }
  }

  async function loadInitialProduct() {
    const ml = material.toLowerCase();

    if (ml.includes("silver")) {
      goldWrap.style.display = "none";
    } else if (ml.includes("rose")) {
      goldWrap.style.display = "block";
      goldLabel.textContent = "Select Rose Gold Type:";
      goldSelect.innerHTML = `
        <option value="Rose Gold">Rose Gold</option>
        <option value="Plated Rose Gold">Plated Rose Gold</option>`;
      goldSelect.value = material;
      goldSelect.onchange = handleMaterialChange;
    } else {
      goldWrap.style.display = "block";
      goldLabel.textContent = "Select Gold Type:";
      goldSelect.innerHTML = `
        <option value="8K Gold">8K Gold</option>
        <option value="10K Gold">10K Gold</option>
        <option value="14K Gold">14K Gold</option>
        <option value="Gold Plated">Gold Plated</option>
        <option value="Florida Gold">Florida Gold</option>`;
      goldSelect.value = material;
      goldSelect.onchange = handleMaterialChange;
    }

    await updatePrice();
  }

  function handleMaterialChange(e) {
    material = e.target.value;
    materialLabelEl.textContent = material;
    updatePrice();
  }

  async function updatePrice() {
    materialLabelEl.textContent = material;
    const rec = await fetchProductBy(productName, material);

    imgEl.src = rec?.img ? `assets/images/${rec.img}` : "assets/images/gold1.jpg";

    const top = selectedTopTeeth.length;
    const bottom = selectedBottomTeeth.length;
    const total = top + bottom;

    const pricePerTooth = rec?.price ? Number(rec.price) : 0;
    let totalPrice = total * pricePerTooth;
    let discount = "";
    if (total >= 6) { totalPrice *= 0.8; discount = "Since you selected 6 or more teeth, you get 20% discount!"; }

    priceEl.textContent = totalPrice.toFixed(2);
    discountNoteEl.textContent = discount;
    topCountEl.value = top;
    bottomCountEl.value = bottom;
  }

  async function addToCart() {
    // must be logged in (cookie)
    const me = await fetch(`${BASE_API}/api/users/me`, { credentials:'include' })
                  .then(r=>r.json()).catch(()=>({loggedIn:false}));
    if (!me.loggedIn) {
      alert("Please log in to save your design.");
      location.href = "login.html";
      return;
    }

    const top = selectedTopTeeth.length;
    const bottom = selectedBottomTeeth.length;
    if (top + bottom === 0) {
      alert("Please select at least one tooth before saving.");
      return;
    }

    const rec = await fetchProductBy(productName, material);
    if (!rec) { alert("Unable to save design: product/price not found."); return; }

    const item = {
      name: productName,
      img: rec.img ? `assets/images/${rec.img}` : imgEl.src,
      material,
      top,
      bottom,
      selectedTop: selectedTopTeeth,
      selectedBottom: selectedBottomTeeth,
      price: Number(document.getElementById('priceValue').textContent) || 0
    };

    try {
      const res = await fetch(`${BASE_API}/api/cart`, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        credentials: 'include',
        body: JSON.stringify(item)
      });
      if (res.status === 401) { alert("Please log in."); location.href="login.html"; return; }
      if (!res.ok) throw new Error(`Save failed (${res.status})`);
      alert("Design saved!");
      location.href = "cart.html";
    } catch (err) {
      alert(err.message);
    }
  }

  document.getElementById("saveBtn").addEventListener("click", addToCart);
  window.onload = loadInitialProduct;
</script>
</body>
</html>