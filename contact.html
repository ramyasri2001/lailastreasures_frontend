<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Contact – Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    textarea { min-height:150px; }
    .hint { font-size:.9rem; color:#666; margin:.5rem 0 1rem; }
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul id="navMenu">
      <li><a href="index.html">Home</a></li>
      <li><a href="grillz.html">Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <!-- user items injected by auth-header.js -->
    </ul>
  </nav>
</header>

<!-- Reusable auth header -->
<script src="assets/js/auth-header.js"></script>

<main>
  <h1>Contact Us</h1>
  <p>Enter your details and message below. We'll get back to you with the next steps!</p>
  <p class="hint">Your current Saved Designs (from your account) will be included when you send.</p>
  
  <form id="contactForm">
    <input type="text" id="contactName" placeholder="Your Name" required>
    <input type="email" id="contactEmail" placeholder="Your Email" required>
    <label for="message">Message:</label>
    <textarea id="message" required></textarea>
    <button id="sendBtn" type="submit">Send</button>
  </form>
</main>

<script>
  const API_BASE = 'https://lailastreasures.onrender.com';

  // Prefill name/email for convenience
  document.addEventListener("DOMContentLoaded", async () => {
    const userName = localStorage.getItem("userName");   // just for UX display
    const userEmail = localStorage.getItem("userEmail"); // optional convenience

    if (userName) document.getElementById("contactName").value = userName;
    if (userEmail) document.getElementById("contactEmail").value = userEmail;

    await fillSummaryFromServerCart();
  });

  async function fetchServerCart() {
    const me = await fetch(`${API_BASE}/api/users/me`, { credentials:'include' })
                .then(r => r.json())
                .catch(() => ({ loggedIn:false }));
    if (!me.loggedIn) return [];
    const res = await fetch(`${API_BASE}/api/cart`, { credentials:'include' });
    if (!res.ok) return [];
    return res.json();
  }

  async function fillSummaryFromServerCart() {
    const items = await fetchServerCart();
    document.getElementById("message").value = buildSummary(items);
  }

  function buildSummary(items) {
    if (!items?.length) {
      return "No designs saved.\n\nPlease let me know the next steps. Thank you!";
    }
    let msg = "Hello,\n\nI am interested in the following grillz designs:\n\n";
    items.forEach((item, i) => {
      const price = Number(item.price) || 0;
      const topList = Array.isArray(item.selectedTop) ? item.selectedTop.join(", ") : "-";
      const bottomList = Array.isArray(item.selectedBottom) ? item.selectedBottom.join(", ") : "-";
      msg += `Design ${i+1}:\n`;
      msg += `Name: ${item.name}\n`;
      msg += `Material: ${item.material || "Not specified"}\n`;
      msg += `Top Teeth (${item.top || 0}): ${topList}\n`;
      msg += `Bottom Teeth (${item.bottom || 0}): ${bottomList}\n`;
      msg += `Price: $${price.toFixed(2)}\n\n`;
    });
    msg += "Please get back to me with the next steps. Thank you!";
    return msg;
  }

  document.getElementById("contactForm").onsubmit = async (e) => {
    e.preventDefault();

    // require login to send
    const me = await fetch(`${API_BASE}/api/users/me`, { credentials:'include' })
                .then(r => r.json())
                .catch(() => ({ loggedIn:false }));
    if (!me.loggedIn) {
      alert("Please log in first.");
      location.href = "login.html";
      return;
    }

    const name = document.getElementById("contactName").value.trim();
    const email = document.getElementById("contactEmail").value.trim();
    const message = document.getElementById("message").value.trim();
    if (!name || !email || !message) {
      alert("Please fill out all fields.");
      return;
    }

    const btn = document.getElementById('sendBtn');
    const original = btn.textContent;
    btn.disabled = true; btn.textContent = 'Sending…';

    try {
      const designs = await fetchServerCart(); // from server cart
      const res = await fetch(`${API_BASE}/api/messages`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify({ name, email, message, designs })
      });
      if (!res.ok) {
        const t = await res.text().catch(()=> '');
        throw new Error(`Server responded ${res.status}. ${t}`);
      }
      alert("Message sent! We'll get back to you soon.");
      document.getElementById("contactForm").reset();
      await fillSummaryFromServerCart();
    } catch (err) {
      console.error('Send message failed:', err);
      alert("Couldn't send message. Please try again in a moment.");
    } finally {
      btn.disabled = false; btn.textContent = original;
    }
  };
</script>
</body>
</html>