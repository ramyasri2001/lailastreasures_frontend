<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Rose Gold Grillz – Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .product-gallery{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin-top:2rem}
    .product{width:250px;text-align:center}
    .product img{width:100%;height:180px;object-fit:cover;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul id="navMenu">
      <li><a href="index.html">Home</a></li>
      <li><a href="grillz.html">Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <!-- user items injected by auth-header.js -->
    </ul>
  </nav>
</header>

<!-- Reusable header controller -->
<script src="assets/js/auth-header.js"></script>

<main>
  <h1 style="text-align:center;">Rose Gold Grillz Collection</h1>
  <div id="productGallery" class="product-gallery"></div>
</main>

<script>
 // const API_BASE = "https://lailastreasures.onrender.com";
  const CATEGORY = "rosegold-grillz.html";

  function normalizeImg(src){
    if (!src) return "assets/images/grillz3.jpg";
    if (src.startsWith("http") || src.startsWith("assets/")) return src;
    return "assets/images/" + src;
  }

  // unique by designKey (preferred) then by name
  function uniqueDesigns(items){
    const map = new Map();
    for (const p of items){
      const key = (p.designKey || p.name || "").toLowerCase();
      if (!key) continue;
      if (!map.has(key)) map.set(key, p);
    }
    return [...map.values()];
  }

  async function fetchProducts(){
    const r = await fetch(`${API_BASE}/api/products?category=${encodeURIComponent(CATEGORY)}`);
    if (!r.ok) throw new Error("Failed to load products");
    return r.json();
  }

  // If GET /api/order is protected, add {credentials:'include'}
  async function fetchOrder(){
    const r = await fetch(`${API_BASE}/api/order?category=${encodeURIComponent(CATEGORY)}`);
    if (!r.ok) return { category:CATEGORY, order: [] };
    return r.json();
  }

  async function load(){
    const gallery = document.getElementById("productGallery");
    gallery.innerHTML = "Loading…";

    // backend first; optional local fallback for resilience
    let products = [];
    try {
      products = await fetchProducts();
    } catch {
      const local = JSON.parse(localStorage.getItem("adminProducts")) || [];
      products = local.filter(p => p.category === CATEGORY);
    }

    if (!products.length){
      gallery.innerHTML = "<p>No products found.</p>";
      return;
    }

    const designs = uniqueDesigns(products);

    // ordering via backend (admin drag+drop)
    let orderKeys = [];
    try {
      const ord = await fetchOrder();
      orderKeys = Array.isArray(ord.order) ? ord.order.map(k => (k||'').toLowerCase()) : [];
    } catch {
      orderKeys = [];
    }

    designs.sort((a,b)=>{
      const ka = (a.designKey || a.name || "").toLowerCase();
      const kb = (b.designKey || b.name || "").toLowerCase();
      const ia = orderKeys.indexOf(ka);
      const ib = orderKeys.indexOf(kb);
      const A = ia === -1 ? Number.POSITIVE_INFINITY : ia;
      const B = ib === -1 ? Number.POSITIVE_INFINITY : ib;
      if (A !== B) return A - B;
      return (a.name || "").localeCompare(b.name || "");
    });

    // render cards
    gallery.innerHTML = "";
    designs.forEach(p=>{
      const img = normalizeImg(p.img);
      const name = p.name || "Design";
      const defaultMaterial = "Rose Gold"; // default selection for this category
      const card = document.createElement("div");
      card.className = "product";
      card.innerHTML = `
        <img src="${img}" alt="${name}">
        <h2>${name}</h2>
        <a href="product.html?name=${encodeURIComponent(name)}&material=${encodeURIComponent(defaultMaterial)}">
          <button>View</button>
        </a>
      `;
      gallery.appendChild(card);
    });
  }

  document.addEventListener('DOMContentLoaded', load);
</script>
</body>
</html>