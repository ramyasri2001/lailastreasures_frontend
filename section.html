<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Collection – Laila's Treasures</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .product-gallery{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin-top:2rem}
    .product{width:260px;text-align:center}
    .product img{width:100%;height:180px;object-fit:cover;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul id="navMenu">
      <li><a href="index.html">Home</a></li>
      <li><a href="grillz.html">Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <!-- user items injected by auth-header.js -->
    </ul>
  </nav>
</header>

<!-- Reusable auth header controller -->
<script src="assets/js/auth-header.js"></script>

<main>
  <h1 id="collectionTitle" style="text-align:center;">Collection</h1>
  <div id="productGallery" class="product-gallery"></div>
</main>

<script>
  const API_BASE = "https://lailastreasures.onrender.com";

  // Read ?slug=gold-grillz.html (or any backend section slug)
  const params = new URLSearchParams(location.search);
  const SLUG = params.get("slug") || "gold-grillz.html";

  // Title beautifier
  function titleFromSlug(slug){
    return (slug || "")
      .replace(/\.html$/i,"")
      .replace(/-/g," ")
      .replace(/\b\w/g, c => c.toUpperCase());
  }

  // Default material by slug (used to preselect in product.html)
  function defaultMaterialForSlug(slug){
    const s = (slug || "").toLowerCase();
    if (s.includes("silver")) return "Silver";
    if (s.includes("rose")) return "Rose Gold";
    return "10K Gold";
  }

  // Image helpers
  function fallbackBySlug(slug){
    const s = (slug || "").toLowerCase();
    if (s.includes("silver")) return "assets/images/silver1.jpg";
    if (s.includes("rose")) return "assets/images/grillz3.jpg";
    return "assets/images/gold1.jpg";
  }
  function normalizeImg(src, slug){
    if (!src) return fallbackBySlug(slug);
    if (src.startsWith("http") || src.startsWith("assets/")) return src;
    return "assets/images/" + src;
  }
  function attachImgFallback(imgEl, slug){
    imgEl.onerror = () => { imgEl.onerror = null; imgEl.src = fallbackBySlug(slug); };
  }

  // Unique by designKey (preferred) then by name
  function uniqueDesigns(items){
    const map = new Map();
    for (const p of items){
      const key = (p.designKey || p.name || "").toLowerCase();
      if (!key) continue;
      if (!map.has(key)) map.set(key, p);
    }
    return [...map.values()];
  }

  async function fetchProducts(){
    const r = await fetch(`${API_BASE}/api/products?category=${encodeURIComponent(SLUG)}`);
    if (!r.ok) throw new Error(`Failed to load products (${r.status})`);
    return r.json();
  }

  // PUBLIC read of order (no cookie needed)
  async function fetchOrder(){
    const r = await fetch(`${API_BASE}/api/order?category=${encodeURIComponent(SLUG)}`);
    if (!r.ok) return { category: SLUG, order: [] };
    return r.json(); // { category, order:[designKey,...] }
  }

  async function load(){
    // Set pretty page title
    const pretty = titleFromSlug(SLUG);
    document.title = `${pretty} – Laila's Treasures`;
    document.getElementById("collectionTitle").textContent = pretty;

    const gallery = document.getElementById("productGallery");
    gallery.innerHTML = "Loading…";

    let products = [];
    try {
      products = await fetchProducts();
    } catch (e) {
      console.error(e);
      gallery.innerHTML = "<p style='color:#b00020'>Couldn't load products.</p>";
      return;
    }
    if (!products.length){
      gallery.innerHTML = "<p>No products found.</p>";
      return;
    }

    const designs = uniqueDesigns(products);

    // order by saved order, then by name
    let orderKeys = [];
    try {
      const ord = await fetchOrder();
      orderKeys = Array.isArray(ord.order) ? ord.order : [];
    } catch { orderKeys = []; }

    designs.sort((a,b)=>{
      const ka = (a.designKey || a.name || "").toLowerCase();
      const kb = (b.designKey || b.name || "").toLowerCase();
      const ia = orderKeys.indexOf(ka);
      const ib = orderKeys.indexOf(kb);
      const A = ia === -1 ? Number.POSITIVE_INFINITY : ia;
      const B = ib === -1 ? Number.POSITIVE_INFINITY : ib;
      if (A !== B) return A - B;
      return (a.name || "").localeCompare(b.name || "");
    });

    // render
    gallery.innerHTML = "";
    const defaultMaterial = defaultMaterialForSlug(SLUG);

    designs.forEach(p=>{
      const name = p.name || "Design";
      const img = normalizeImg(p.img, SLUG);
      const card = document.createElement("div");
      card.className = "product";
      card.innerHTML = `
        <img src="${img}" alt="${name}">
        <h2>${name}</h2>
        <a href="product.html?name=${encodeURIComponent(name)}&material=${encodeURIComponent(defaultMaterial)}">
          <button>View</button>
        </a>
      `;
      attachImgFallback(card.querySelector("img"), SLUG);
      gallery.appendChild(card);
    });
  }

  document.addEventListener("DOMContentLoaded", load);
</script>
</body>
</html>