<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Silver Grillz – Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    .product-gallery{display:flex;flex-wrap:wrap;justify-content:center;gap:2rem;margin-top:2rem}
    .product{width:250px;text-align:center}
    .product img{width:100%;height:180px;object-fit:cover;border-radius:8px}
  </style>
</head>
<body>
<header>
  <div class="logo">Laila's Treasures</div>
  <nav>
    <ul>
      <li><span id="userNameDisplay" style="font-weight:bold;margin-left:10px;color:yellow;"></span><a href="grillz.html">  Grillz</a></li>
      <li><a href="cart.html">Saved Designs</a></li>
      <li><a href="contact.html">Contact</a></li>
      <li><a href="#" id="logoutBtn">Logout</a></li>
    </ul>
  </nav>
</header>

<main>
  <h1 style="text-align:center;">Silver Grillz Collection</h1>
  <div id="productGallery" class="product-gallery"></div>
</main>

<script>
  const API_BASE = "https://lailastreasures.onrender.com";
  const CATEGORY = "silver-grillz.html";

  // Show username in header
  (function initHeader(){
    const userName = localStorage.getItem("userName");
    if (userName && localStorage.getItem("userLoggedIn")==="true"){
      document.getElementById("userNameDisplay").textContent = `(${userName})`;
    }
  })();

  // Logout handler
  document.getElementById("logoutBtn").addEventListener("click", async (e)=>{
    e.preventDefault();
    try { await fetch(`${API_BASE}/api/users/logout`, { method:'POST', credentials:'include' }); } catch {}
    localStorage.removeItem("userLoggedIn");
    localStorage.removeItem("userName");
    localStorage.removeItem("userEmail");
    alert("You have been logged out.");
    location.href="login.html";
  });

  function normalizeImg(src){
    if (!src) return "assets/images/silver1.jpg";
    if (src.startsWith("http") || src.startsWith("assets/")) return src;
    return "assets/images/" + src;
  }

  function uniqueDesigns(items){
    const map = new Map();
    for (const p of items){
      const key = (p.designKey || p.name || "").toLowerCase();
      if (key && !map.has(key)) map.set(key, p);
    }
    return [...map.values()];
  }

  async function fetchProducts(){
    const r = await fetch(`${API_BASE}/api/products?category=${encodeURIComponent(CATEGORY)}`);
    if (!r.ok) throw new Error("Failed to load products");
    return r.json();
  }

  async function fetchOrder(){
    const r = await fetch(`${API_BASE}/api/order?category=${encodeURIComponent(CATEGORY)}`, { credentials:'include' });
    if (!r.ok) return { order: [] };
    return r.json();
  }

  function loadLocalOrder(category){
    return JSON.parse(localStorage.getItem(`order:${category}`)) || [];
  }

  async function load(){
    const gallery = document.getElementById("productGallery");
    gallery.innerHTML = "Loading…";

    let products = [];
    try {
      products = await fetchProducts();
    } catch {
      const local = JSON.parse(localStorage.getItem("adminProducts")) || [];
      products = local.filter(p => p.category === CATEGORY);
    }

    if (!products.length){
      gallery.innerHTML = "<p>No products found.</p>";
      return;
    }

    const designs = uniqueDesigns(products);

    let orderKeys = [];
    try {
      const ord = await fetchOrder();
      orderKeys = Array.isArray(ord.order) ? ord.order : [];
    } catch {
      orderKeys = loadLocalOrder(CATEGORY);
    }

    designs.sort((a,b)=>{
      const ka = (a.designKey || a.name || "").toLowerCase();
      const kb = (b.designKey || b.name || "").toLowerCase();
      const ia = orderKeys.indexOf(ka);
      const ib = orderKeys.indexOf(kb);
      const A = ia === -1 ? Number.POSITIVE_INFINITY : ia;
      const B = ib === -1 ? Number.POSITIVE_INFINITY : ib;
      if (A !== B) return A - B;
      return (a.name || "").localeCompare(b.name || "");
    });

    gallery.innerHTML = "";
    designs.forEach(p=>{
      const img = normalizeImg(p.img);
      const name = p.name || "Design";
      const defaultMaterial = "Silver";
      const card = document.createElement("div");
      card.className = "product";
      card.innerHTML = `
        <img src="${img}" alt="${name}">
        <h2>${name}</h2>
        <a href="product.html?name=${encodeURIComponent(name)}&material=${encodeURIComponent(defaultMaterial)}">
          <button>View</button>
        </a>
      `;
      gallery.appendChild(card);
    });
  }

  load();
</script>
</body>
</html>