<!DOCTYPE html>
<html>
<head>
  <title>Admin Dashboard - Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body { padding: 2rem; font-family: Arial; }
    .section { margin-bottom: 3rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    input, select { margin-bottom: 0.5rem; padding: 0.4rem; width: 100%; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; background: gold; border: none; font-weight: bold; cursor: pointer; }
    img.product-preview { width: 60px; height: auto; border-radius: 4px; }
    .message-box { margin-bottom: 1rem; border: 1px solid #ddd; padding: 1rem; background: #f9f9f9; }
    .error { color: #b00020; margin-top: .5rem; }
  .order-item {
    display:flex; align-items:center; gap:.75rem;
    padding:.6rem .8rem; border-bottom:1px solid #eee; cursor:grab;
    background:#fff;
  }
  .order-item:last-child { border-bottom:none; }
  .order-handle {
    width:12px; height:18px; background:repeating-linear-gradient(
      to bottom, #bbb, #bbb 3px, #eee 3px, #eee 6px
    ); border-radius:3px; flex:0 0 12px;
  }
  .order-item.dragging { opacity:.6; }
  </style>
</head>
<body>
  <h1>Admin Panel - Laila's Treasures</h1>

  <div class="section">
    <h2>Manage Products</h2>
    <p style="margin:0;color:#666;">Save will <b>upsert</b> by <i>name + material + category</i>.</p>

    <form id="productForm">
      <input type="hidden" id="editId">
      <input type="text" id="productName" placeholder="Product Name" required>
      <input type="text" id="productImage" placeholder="Image filename (e.g. gold1.jpg)" required>

      <select id="productMaterial" required>
        <option value="">Select Material</option>
        <option value="8K Gold">8K Gold</option>
        <option value="10K Gold">10K Gold</option>
        <option value="14K Gold">14K Gold</option>
        <option value="Gold Plated">Gold Plated</option>
        <option value="Florida Gold">Florida Gold</option>
        <option value="Silver">Silver</option>
        <option value="Rose Gold">Rose Gold</option>
        <option value="Plated Rose Gold">Plated Rose Gold</option>
      </select>

      <input type="number" id="productPrice" placeholder="Price Per Tooth" required step="0.01" min="0">

      <select id="productCategory" required>
        <option value="">Select Category</option>
        <option value="gold-grillz.html">Gold</option>
        <option value="silver-grillz.html">Silver</option>
        <option value="rosegold-grillz.html">Rose Gold</option>
      </select>

      <div style="display:flex; gap: .6rem;">
        <button type="submit">Save Product</button>
        <button type="button" id="clearBtn">Clear</button>
      </div>
      <div id="formError" class="error"></div>
    </form>

    <div id="productList" style="margin-top:1rem;"></div>
  </div>
<!-- ✅ Arrange Designs (drag & drop) -->
<div class="section">
  <h2>Arrange Designs (drag & drop)</h2>

  <label>Pick a section:</label>
  <select id="orderCategory">
    <option value="gold-grillz.html">Gold</option>
    <option value="silver-grillz.html">Silver</option>
    <option value="rosegold-grillz.html">Rose Gold</option>
  </select>

  <div style="margin: 1rem 0;">
    <button id="reloadOrder">Load Designs</button>
    <button id="saveOrder" style="background:#10b981;color:#fff;">Save Order</button>
  </div>

  <ul id="orderList" style="list-style:none;padding:0;margin:0;border:1px solid #eee;border-radius:8px;">
    <!-- Draggable items injected here -->
  </ul>

  <p style="margin-top:.5rem;color:#666;">Tip: drag items to reorder; click “Save Order”.</p>
</div>

  <div class="section">
    <h2>Customer Messages</h2>
    <div id="messageList"><em>Messages migration coming later</em></div>
  </div>

<script>
  // ---- CONFIG: Backend base URL ----
  const API_BASE = 'https://lailastreasures.onrender.com'; // Render backend
  const PRODUCTS_API = `${API_BASE}/api/products`;

  // ---- Auth gate (same as before) ----
  if (!localStorage.getItem("userLoggedIn")) {
    window.location.href = "login.html";
  }

  // Utilities
  const $ = sel => document.querySelector(sel);
  const slugify = s => s.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');

  // Load list
  async function loadProducts() {
    const list = $('#productList');
    list.innerHTML = 'Loading...';
    try {
      const res = await fetch(PRODUCTS_API, { credentials: 'omit' });
      if (!res.ok) throw new Error(`List failed: ${res.status}`);
      const items = await res.json();

      if (!items.length) {
        list.innerHTML = "<p>No products added yet.</p>";
        return;
      }

      let html = `<table><thead>
        <tr><th>Name</th><th>Image</th><th>Material</th><th>Price</th><th>Category</th><th>Actions</th></tr>
      </thead><tbody>`;

      items.forEach(p => {
        html += `<tr>
          <td>${p.name}</td>
          <td><img src="assets/images/${p.img}" class="product-preview" alt="${p.name}"></td>
          <td>${p.material || ''}</td>
          <td>$${Number(p.price || 0).toFixed(2)}</td>
          <td>${(p.category || '').replace('.html','')}</td>
          <td>
            <button onclick='fillForm(${JSON.stringify(p).replace(/'/g,"&#39;")})'>Edit</button>
            <button onclick="deleteProduct('${p._id}')" style="background:red;color:#fff;">Delete</button>
          </td>
        </tr>`;
      });

      html += "</tbody></table>";
      list.innerHTML = html;
    } catch (err) {
      console.error(err);
      list.innerHTML = `<p class="error">Error loading products: ${err.message}</p>`;
      alert('Failed to fetch (list). Check CORS and backend.');
    }
  }

  // Fill form for edit
  function fillForm(p) {
    $('#editId').value = p._id || '';
    $('#productName').value = p.name || '';
    $('#productImage').value = p.img || '';
    $('#productMaterial').value = p.material || '';
    $('#productPrice').value = p.price || '';
    $('#productCategory').value = p.category || '';
    $('#formError').textContent = '';
  }

  // Clear form
  $('#clearBtn').addEventListener('click', () => {
    $('#productForm').reset();
    $('#editId').value = '';
    $('#formError').textContent = '';
  });

  // Save (upsert)
  document.getElementById('productForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    $('#formError').textContent = '';

    const name = $('#productName').value.trim();
    const img = $('#productImage').value.trim();
    const material = $('#productMaterial').value.trim();
    const price = parseFloat($('#productPrice').value);
    const category = $('#productCategory').value;
    const designKey = slugify(name); // backend expects this field

    const payload = { name, designKey, category, material, price, img };

    try {
      const res = await fetch(PRODUCTS_API, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      });
      if (!res.ok) {
        const t = await res.text();
        throw new Error(`Save failed: ${res.status} ${t}`);
      }
      alert('Saved!');
      $('#productForm').reset();
      $('#editId').value = '';
      loadProducts();
    } catch (err) {
      console.error(err);
      $('#formError').textContent = err.message;
      alert('Failed to fetch (save). Check backend URL/CORS.');
    }
  });

  // Delete
  async function deleteProduct(id) {
    if (!id) return alert('Missing id for delete.');
    if (!confirm('Delete this product?')) return;
    try {
      const res = await fetch(`${PRODUCTS_API}/${id}`, { method: 'DELETE' });
      if (!res.ok) throw new Error(`Delete failed: ${res.status}`);
      loadProducts();
    } catch (err) {
      console.error(err);
      alert('Failed to fetch (delete).');
    }
  }
  window.deleteProduct = deleteProduct; // expose for onclick
<script>
  // ===== Drag & drop ordering (localStorage) =====
  const orderCategoryEl = document.getElementById('orderCategory');
  const orderListEl = document.getElementById('orderList');
  document.getElementById('reloadOrder').addEventListener('click', buildOrderList);
  document.getElementById('saveOrder').addEventListener('click', saveOrder);

  function getProductsLS() {
    return JSON.parse(localStorage.getItem('adminProducts')) || [];
  }

  function uniqueDesignsByCategory(category) {
    const prods = getProductsLS().filter(p => p.category === category);
    const map = {};
    prods.forEach(p => {
      if (!map[p.name]) map[p.name] = p; // one per design (any material)
    });
    return Object.values(map);
  }

  function loadSavedOrder(category) {
    return JSON.parse(localStorage.getItem(`order:${category}`)) || [];
  }

  function buildOrderList() {
    const category = orderCategoryEl.value;
    const designs = uniqueDesignsByCategory(category);

    // current saved order (array of names)
    const saved = loadSavedOrder(category);

    // sort designs according to saved order; unknowns go to the end
    designs.sort((a, b) => {
      const ia = saved.indexOf(a.name);
      const ib = saved.indexOf(b.name);
      const A = ia === -1 ? 999999 : ia;
      const B = ib === -1 ? 999999 : ib;
      return A - B || a.name.localeCompare(b.name);
    });

    orderListEl.innerHTML = '';
    designs.forEach(d => {
      const li = document.createElement('li');
      li.className = 'order-item';
      li.draggable = true;
      li.dataset.name = d.name;
      li.innerHTML = `
        <div class="order-handle" title="Drag"></div>
        <img src="assets/images/${d.img}" alt="" style="width:48px;height:32px;object-fit:cover;border-radius:4px;">
        <div style="font-weight:600">${d.name}</div>
      `;
      addDragEvents(li);
      orderListEl.appendChild(li);
    });
  }

  function saveOrder() {
    const category = orderCategoryEl.value;
    const names = [...orderListEl.querySelectorAll('.order-item')].map(li => li.dataset.name);
    localStorage.setItem(`order:${category}`, JSON.stringify(names));
    alert('Order saved!');
  }

  function addDragEvents(el) {
    el.addEventListener('dragstart', e => {
      el.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
    });
    el.addEventListener('dragend', () => el.classList.remove('dragging'));
  }

  orderListEl.addEventListener('dragover', e => {
    e.preventDefault();
    const dragging = orderListEl.querySelector('.dragging');
    const after = getDragAfterElement(orderListEl, e.clientY);
    if (!dragging) return;
    if (after == null) orderListEl.appendChild(dragging);
    else orderListEl.insertBefore(dragging, after);
  });

  function getDragAfterElement(container, y) {
    const els = [...container.querySelectorAll('.order-item:not(.dragging)')];
    return els.reduce((closest, child) => {
      const box = child.getBoundingClientRect();
      const offset = y - box.top - box.height / 2;
      if (offset < 0 && offset > closest.offset) return { offset, element: child };
      else return closest;
    }, { offset: Number.NEGATIVE_INFINITY }).element;
  }

  // Build list on first load
  buildOrderList();
</script>

  // Init
  loadProducts();
</script>
</body>
</html>