<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Admin Dashboard - Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body { padding: 2rem; font-family: Arial, sans-serif; }
    .section { margin-bottom: 3rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 1rem; }
    th, td { border: 1px solid #ccc; padding: 0.5rem; text-align: left; }
    input, select { margin-bottom: 0.5rem; padding: 0.4rem; width: 100%; }
    button { padding: 0.5rem 1rem; margin-top: 0.5rem; background: gold; border: none; font-weight: bold; cursor: pointer; }
    img.product-preview { width: 60px; height: auto; border-radius: 4px; }
    .error { color: #b00020; margin-top: .5rem; }
    /* Drag & drop ordering */
    .order-item {
      display:flex; align-items:center; gap:.75rem;
      padding:.6rem .8rem; border-bottom:1px solid #eee; cursor:grab; background:#fff;
    }
    .order-item:last-child { border-bottom:none; }
    .order-handle {
      width:12px; height:18px; background:repeating-linear-gradient(to bottom,#bbb,#bbb 3px,#eee 3px,#eee 6px);
      border-radius:3px; flex:0 0 12px;
    }
    .order-item.dragging { opacity:.6; }
  </style>
</head>
<body>
  <h1>Admin Panel - Laila's Treasures</h1>

  <div class="section">
    <h2>Manage Products</h2>
    <p style="margin:0;color:#666;">Save will <b>upsert</b> by <i>name + material + category</i>.</p>

    <form id="productForm">
      <input type="hidden" id="editId">
      <input type="text" id="productName" placeholder="Product Name" required>
      <input type="text" id="productImage" placeholder="Image filename (e.g. gold1.jpg)" required>

      <select id="productMaterial" required>
        <option value="">Select Material</option>
        <option value="8K Gold">8K Gold</option>
        <option value="10K Gold">10K Gold</option>
        <option value="14K Gold">14K Gold</option>
        <option value="Gold Plated">Gold Plated</option>
        <option value="Florida Gold">Florida Gold</option>
        <option value="Silver">Silver</option>
        <option value="Rose Gold">Rose Gold</option>
        <option value="Plated Rose Gold">Plated Rose Gold</option>
      </select>

      <input type="number" id="productPrice" placeholder="Price Per Tooth" required step="0.01" min="0">

      <select id="productCategory" required>
        <option value="">Select Category</option>
        <option value="gold-grillz.html">Gold</option>
        <option value="silver-grillz.html">Silver</option>
        <option value="rosegold-grillz.html">Rose Gold</option>
      </select>

      <div style="display:flex; gap:.6rem;">
        <button type="submit">Save Product</button>
        <button type="button" id="clearBtn">Clear</button>
      </div>
      <div id="formError" class="error"></div>
    </form>

    <div id="productList" style="margin-top:1rem;"></div>
  </div>

  <!-- Arrange Designs (drag & drop) -->
  <div class="section">
    <h2>Arrange Designs (drag & drop)</h2>

    <label>Pick a section:</label>
    <select id="orderCategory">
      <option value="gold-grillz.html">Gold</option>
      <option value="silver-grillz.html">Silver</option>
      <option value="rosegold-grillz.html">Rose Gold</option>
    </select>

    <div style="margin: 1rem 0;">
      <button id="reloadOrder">Load Designs</button>
      <button id="saveOrder" style="background:#10b981;color:#fff;">Save Order</button>
    </div>

    <ul id="orderList" style="list-style:none;padding:0;margin:0;border:1px solid #eee;border-radius:8px;">
      <!-- Draggable items injected here -->
    </ul>

    <p style="margin-top:.5rem;color:#666;">Tip: drag items to reorder; click “Save Order”.</p>
  </div>

  <script>
    // ---- Backend base URL ----
    const API_BASE = 'https://lailastreasures.onrender.com';
    const PRODUCTS_API = `${API_BASE}/api/products`;
    const ORDER_API    = `${API_BASE}/api/order`;

    // ---- Admin gate (requires login cookie AND isAdmin)
    (async function guard(){
      try {
        const r = await fetch(`${API_BASE}/api/users/me`, { credentials:'include' });
        const me = r.ok ? await r.json() : { loggedIn:false };
        if (!me.loggedIn || !me.isAdmin) {
          // Don’t reveal the existence of admin: just bounce to login
          location.href = 'login.html';
          return;
        }
        // load only after we know we’re allowed
        buildOrderList();
        loadProducts();
      } catch {
        location.href = 'login.html';
      }
    })();

    // Utilities
    const $ = sel => document.querySelector(sel);
    const slugify = s => s.toLowerCase().trim().replace(/\s+/g,'-').replace(/[^a-z0-9\-]/g,'');

    // ===== Products list & CRUD =====
    async function loadProducts() {
      const list = $('#productList');
      list.innerHTML = 'Loading...';
      try {
        // listing can be public
        const res = await fetch(PRODUCTS_API);
        if (!res.ok) throw new Error(`List failed: ${res.status}`);
        const items = await res.json();

        if (!items.length) { list.innerHTML = "<p>No products added yet.</p>"; return; }

        let html = `<table><thead>
          <tr><th>Name</th><th>Image</th><th>Material</th><th>Price</th><th>Category</th><th>Actions</th></tr>
        </thead><tbody>`;

        items.forEach(p => {
          const imgSrc = (p.img?.startsWith('http') || p.img?.startsWith('assets/')) ? p.img : `assets/images/${p.img||''}`;
          html += `<tr>
            <td>${p.name || ''}</td>
            <td><img src="${imgSrc}" class="product-preview" alt="${p.name||''}"></td>
            <td>${p.material || ''}</td>
            <td>$${Number(p.price || 0).toFixed(2)}</td>
            <td>${(p.category || '').replace('.html','')}</td>
            <td>
              <button onclick='fillForm(${JSON.stringify(p).replace(/'/g,"&#39;")})'>Edit</button>
              <button onclick="deleteProduct('${p._id}')" style="background:red;color:#fff;">Delete</button>
            </td>
          </tr>`;
        });

        html += "</tbody></table>";
        list.innerHTML = html;
      } catch (err) {
        console.error(err);
        list.innerHTML = `<p class="error">Error loading products: ${err.message}</p>`;
      }
    }

    function fillForm(p) {
      $('#editId').value = p._id || '';
      $('#productName').value = p.name || '';
      $('#productImage').value = p.img || '';
      $('#productMaterial').value = p.material || '';
      $('#productPrice').value = p.price || '';
      $('#productCategory').value = p.category || '';
      $('#formError').textContent = '';
    }

    $('#clearBtn').addEventListener('click', () => {
      $('#productForm').reset();
      $('#editId').value = '';
      $('#formError').textContent = '';
    });

    // Save (upsert) — ADMIN ONLY (credentials included)
    document.getElementById('productForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      $('#formError').textContent = '';

      const name = $('#productName').value.trim();
      const img = $('#productImage').value.trim();
      const material = $('#productMaterial').value.trim();
      const price = parseFloat($('#productPrice').value);
      const category = $('#productCategory').value;
      const designKey = slugify(name);
      const payload = { name, designKey, category, material, price, img };

      try {
        const res = await fetch(PRODUCTS_API, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',                 // send auth cookie (admin check server-side)
          body: JSON.stringify(payload)
        });
        if (!res.ok) {
          const t = await res.text().catch(()=> '');
          throw new Error(`Save failed: ${res.status} ${t}`);
        }
        alert('Saved!');
        $('#productForm').reset();
        $('#editId').value = '';
        loadProducts();
      } catch (err) {
        console.error(err);
        $('#formError').textContent = err.message;
        alert('Failed to save. Check you are logged in as admin.');
      }
    });

    // Delete — ADMIN ONLY
    async function deleteProduct(id) {
      if (!id) return alert('Missing id for delete.');
      if (!confirm('Delete this product?')) return;
      try {
        const res = await fetch(`${PRODUCTS_API}/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!res.ok) throw new Error(`Delete failed: ${res.status}`);
        loadProducts();
      } catch (err) {
        console.error(err);
        alert('Failed to delete. Check you are logged in as admin.');
      }
    }
    window.deleteProduct = deleteProduct;

    // ===== Arrange Designs: Drag & Drop =====
    const orderCategoryEl = document.getElementById('orderCategory');
    const orderListEl = document.getElementById('orderList');
    document.getElementById('reloadOrder').addEventListener('click', buildOrderList);
    document.getElementById('saveOrder').addEventListener('click', saveOrder);

    async function fetchProductsByCategory(category) {
      const res = await fetch(`${PRODUCTS_API}?category=${encodeURIComponent(category)}`);
      if (!res.ok) throw new Error('Failed to fetch products');
      return res.json();
    }
    async function fetchOrder(category) {
      const res = await fetch(`${ORDER_API}?category=${encodeURIComponent(category)}`, {
        credentials: 'include'
      });
      if (!res.ok) return { category, order: [] };
      return res.json();
    }
    async function putOrder(category, order) {
      const res = await fetch(ORDER_API, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'include',
        body: JSON.stringify({ category, order })
      });
      if (!res.ok) throw new Error('Failed to save order');
      return res.json();
    }

    function uniqueByDesignKey(products) {
      const map = new Map();
      for (const p of products) if (p.designKey && !map.has(p.designKey)) map.set(p.designKey, p);
      return [...map.values()];
    }

    async function buildOrderList() {
      const category = orderCategoryEl.value;
      orderListEl.innerHTML = '<li style="padding:.8rem;color:#666">Loading…</li>';

      try {
        const [prods, ord] = await Promise.all([
          fetchProductsByCategory(category),
          fetchOrder(category)
        ]);
        const designs = uniqueByDesignKey(prods);
        const savedOrder = Array.isArray(ord.order) ? ord.order : [];

        designs.sort((a, b) => {
          const ia = savedOrder.indexOf(a.designKey);
          const ib = savedOrder.indexOf(b.designKey);
          const A = ia === -1 ? 999999 : ia;
          const B = ib === -1 ? 999999 : ib;
          return A - B || (a.name||'').localeCompare(b.name||'');
        });

        orderListEl.innerHTML = '';
        designs.forEach(d => {
          const imgSrc = (d.img?.startsWith('http') || d.img?.startsWith('assets/')) ? d.img : `assets/images/${d.img||''}`;
          const li = document.createElement('li');
          li.className = 'order-item';
          li.draggable = true;
          li.dataset.designKey = d.designKey;
          li.innerHTML = `
            <div class="order-handle" title="Drag"></div>
            <img src="${imgSrc}" alt="" style="width:48px;height:32px;object-fit:cover;border-radius:4px;">
            <div style="font-weight:600">${d.name||''}</div>
            <div style="color:#888;margin-left:auto">${d.material||''}</div>
          `;
          addDragEvents(li);
          orderListEl.appendChild(li);
        });

      } catch (err) {
        orderListEl.innerHTML = `<li style="padding:.8rem;color:#c00">Error: ${err.message}</li>`;
        console.error(err);
      }
    }

    async function saveOrder() {
      const category = orderCategoryEl.value;
      const designKeys = [...orderListEl.querySelectorAll('.order-item')].map(li => li.dataset.designKey);
      try {
        await putOrder(category, designKeys);
        alert('Order saved to backend!');
      } catch (err) {
        alert('Failed to save order: ' + err.message);
      }
    }

    function addDragEvents(el) {
      el.addEventListener('dragstart', e => { el.classList.add('dragging'); e.dataTransfer.effectAllowed = 'move'; });
      el.addEventListener('dragend', () => el.classList.remove('dragging'));
    }
    orderListEl.addEventListener('dragover', e => {
      e.preventDefault();
      const dragging = orderListEl.querySelector('.dragging');
      const after = getDragAfterElement(orderListEl, e.clientY);
      if (!dragging) return;
      if (after == null) orderListEl.appendChild(dragging);
      else orderListEl.insertBefore(dragging, after);
    });
    function getDragAfterElement(container, y) {
      const els = [...container.querySelectorAll('.order-item:not(.dragging)')];
      return els.reduce((closest, child) => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) return { offset, element: child };
        else return closest;
      }, { offset: Number.NEGATIVE_INFINITY }).element;
    }
  </script>
</body>
</html>