<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Admin – Laila's Treasures</title>
  <link rel="stylesheet" href="assets/css/style.css">
  <style>
    body { padding:2rem; font-family:Arial, sans-serif; background:#f9f9f9; }
    h1 { margin-top:0 }
    .grid { display:grid; gap:2rem }
    .card { border:1px solid #ddd; border-radius:8px; padding:1rem; background:#fff }
    .row { display:flex; gap:.75rem; flex-wrap:wrap }
    input, select { padding:.5rem; border:1px solid #ccc; border-radius:6px }
    button { padding:.55rem 1rem; border:0; border-radius:8px; font-weight:600; cursor:pointer }
    table { width:100%; border-collapse:collapse; margin-top:.75rem }
    th, td { padding:.5rem; border-bottom:1px solid #eee; text-align:left }
    .error { color:#b00020; margin-top:.5rem }
    .ok { color:#0f766e; margin-top:.5rem }
    /* drag list */
    .order-item { display:flex; align-items:center; gap:.75rem; padding:.6rem .8rem; border-bottom:1px solid #eee; cursor:grab; background:#fff }
    .order-item:last-child { border-bottom:none }
    .order-handle { width:12px; height:18px; background:repeating-linear-gradient(to bottom,#bbb,#bbb 3px,#eee 3px,#eee 6px); border-radius:3px; flex:0 0 12px }
    .order-item.dragging { opacity:.6 }
  </style>
</head>
<body>
<!-- Admin top bar -->
<div id="adminBar" style="display:flex;justify-content:space-between;align-items:center;background:#111;color:#fff;padding:.5rem .8rem;border-radius:8px; margin-bottom:1rem;">
  <div><strong>Admin</strong> <span id="adminName" style="opacity:.8;margin-left:.5rem;"></span></div>
  <div style="display:flex;gap:.5rem;align-items:center;">
    <a href="index.html" style="color:#ffd64d;text-decoration:none;">← Back</a>
    <button id="adminLogoutBtn" style="background:#e11d48;color:#fff;border:none;padding:.4rem .7rem;border-radius:6px;cursor:pointer;">Logout</button>
  </div>
</div>

<h1>Admin Panel</h1>
<div class="grid">

  <!-- Sections -->
  <section class="card">
    <h2>Sections</h2>
    <form id="sectionForm" class="row" style="align-items:flex-end; margin-top:.75rem">
      <div><label>Slug</label><br><input id="secSlug" placeholder="gold-grillz.html" required></div>
      <div><label>Name</label><br><input id="secName" placeholder="Gold Grillz" required></div>
      <div><label>Image</label><br><input id="secImage" placeholder="grillz1.jpg"></div>
      <div><label>Position</label><br><input id="secPos" type="number" value="0"></div>
      <div><button type="submit" style="background:#f59e0b">Save</button></div>
    </form>
    <div id="sectionMsg"></div>
    <div id="sectionsList" style="margin-top:1rem">Loading…</div>
  </section>

  <!-- Products -->
  <section class="card">
    <h2>Products</h2>
    <form id="productForm" style="margin-top:.75rem">
      <input type="hidden" id="editId">
      <div class="row">
        <div><label>Name</label><br><input id="productName" required></div>
        <div><label>Material</label><br><input id="productMaterial" required></div>
        <div><label>Category (section slug)</label><br><input id="productCategory" required></div>
        <div><label>Price / tooth</label><br><input id="productPrice" type="number" step="0.01" min="0" required></div>
        <div><label>Image</label><br><input id="productImage" required></div>
      </div>
      <div class="row" style="margin-top:.5rem">
        <button type="submit" style="background:#10b981;color:#fff">Save</button>
        <button type="button" id="clearBtn">Clear</button>
      </div>
      <div id="formError" class="error"></div>
    </form>
    <div id="productList" style="margin-top:1rem">Loading…</div>
  </section>

  <!-- Arrange designs -->
  <section class="card">
    <h2>Arrange Designs</h2>
    <div class="row" style="align-items:center">
      <select id="orderSection"></select>
      <button id="reloadOrder">Load</button>
      <button id="saveOrder" style="background:#0ea5e9;color:#fff">Save Order</button>
    </div>
    <ul id="orderList" style="list-style:none;padding:0;margin:1rem 0 0;border:1px solid #eee;border-radius:8px"></ul>
  </section>

</div>

<script>
const API_BASE = 'https://lailastreasures.onrender.com';
const PRODUCTS_API = `${API_BASE}/api/products`;
const ORDER_API    = `${API_BASE}/api/order`;
const SECTIONS_API = `${API_BASE}/api/sections`;

/* ---------- Admin guard ---------- */
(async function guard(){
  try{
    const r = await fetch(`${API_BASE}/api/users/me`, { credentials:'include' });
    const me = r.ok ? await r.json() : {loggedIn:false};
    if(!me.loggedIn || !me.isAdmin){
      alert('Admins only'); location.href='login.html'; return;
    }
    document.getElementById('adminName').textContent = `(${me.name})`;
    await Promise.all([loadSections(), loadProducts(), fillSectionDropdown()]);
    buildOrderList();
  }catch{
    location.href='login.html';
  }
})();

/* ---------- Logout ---------- */
document.getElementById('adminLogoutBtn').addEventListener('click', async()=>{
  try{ await fetch(`${API_BASE}/api/users/logout`, {method:'POST',credentials:'include'});}catch{}
  localStorage.removeItem('userName');
  location.href='login.html';
});

/* ---------- Sections ---------- */
async function loadSections(){
  const box = document.getElementById('sectionsList');
  try{
    const r = await fetch(SECTIONS_API, { credentials:'include' });
    if(!r.ok) throw new Error('Load fail');
    const rows = await r.json();
    if(!rows.length){ box.innerHTML = '<p>No sections yet.</p>'; return; }
    rows.sort((a,b)=> (a.position||0)-(b.position||0));
    let html = `<table><tr><th>Pos</th><th>Name</th><th>Slug</th><th>Img</th><th></th></tr>`;
    rows.forEach(s=>{
      html += `<tr><td>${s.position}</td><td>${s.name}</td><td>${s.slug}</td>
        <td>${s.image?`<img src="assets/images/${s.image}" style="width:60px">`:''}</td>
        <td><button onclick="deleteSection('${s._id}')" style="background:#ef4444;color:#fff">X</button></td></tr>`;
    });
    html += `</table>`;
    box.innerHTML=html;
  }catch(e){ box.innerHTML=`<p class="error">${e.message}</p>`; }
}
async function deleteSection(id){
  if(!confirm('Delete section?')) return;
  await fetch(`${SECTIONS_API}/${id}`,{method:'DELETE',credentials:'include'});
  loadSections(); fillSectionDropdown();
}
document.getElementById('sectionForm').onsubmit = async e=>{
  e.preventDefault();
  const slug=document.getElementById('secSlug').value.trim();
  const name=document.getElementById('secName').value.trim();
  const image=document.getElementById('secImage').value.trim();
  const position=Number(document.getElementById('secPos').value||0);
  const r=await fetch(SECTIONS_API,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({slug,name,image,position})});
  if(!r.ok) return alert('Save failed');
  e.target.reset(); loadSections(); fillSectionDropdown();
};

/* ---------- Products ---------- */
async function loadProducts(){
  const list=document.getElementById('productList');
  try{
    const r=await fetch(PRODUCTS_API);
    const items=await r.json();
    if(!items.length){ list.innerHTML='<p>No products.</p>'; return; }
    let html='<table><tr><th>Name</th><th>Img</th><th>Mat</th><th>Price</th><th>Cat</th><th></th></tr>';
    items.forEach(p=>{
      html+=`<tr><td>${p.name}</td><td><img src="assets/images/${p.img}" style="width:50px"></td>
      <td>${p.material}</td><td>$${p.price}</td><td>${p.category}</td>
      <td><button onclick="deleteProduct('${p._id}')" style="background:#ef4444;color:#fff">X</button></td></tr>`;
    });
    html+='</table>'; list.innerHTML=html;
  }catch(e){ list.innerHTML=`<p class="error">${e.message}</p>`; }
}
document.getElementById('productForm').onsubmit = async e=>{
  e.preventDefault();
  const payload={
    name:document.getElementById('productName').value.trim(),
    material:document.getElementById('productMaterial').value.trim(),
    category:document.getElementById('productCategory').value.trim(),
    price:parseFloat(document.getElementById('productPrice').value),
    img:document.getElementById('productImage').value.trim(),
    designKey:document.getElementById('productName').value.trim().toLowerCase().replace(/\s+/g,'-')
  };
  const r=await fetch(PRODUCTS_API,{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify(payload)});
  if(!r.ok) return alert('Save failed');
  e.target.reset(); loadProducts();
};
async function deleteProduct(id){
  if(!confirm('Delete product?')) return;
  await fetch(`${PRODUCTS_API}/${id}`,{method:'DELETE',credentials:'include'});
  loadProducts();
}

/* ---------- Order ---------- */
async function fillSectionDropdown(){
  const sel=document.getElementById('orderSection'); sel.innerHTML='';
  const r=await fetch(SECTIONS_API,{credentials:'include'}); const rows=await r.json();
  rows.forEach(s=>{ const opt=document.createElement('option'); opt.value=s.slug; opt.textContent=s.name; sel.appendChild(opt); });
}
async function buildOrderList(){
  const slug=document.getElementById('orderSection').value; const list=document.getElementById('orderList');
  const [prods,ord]=await Promise.all([fetch(`${PRODUCTS_API}?category=${encodeURIComponent(slug)}`).then(r=>r.json()),fetch(`${ORDER_API}?category=${encodeURIComponent(slug)}`,{credentials:'include'}).then(r=>r.json()).catch(()=>({order:[]}))]);
  const map=new Map(); prods.forEach(p=>{if(p.designKey&&!map.has(p.designKey))map.set(p.designKey,p);});
  const designs=[...map.values()]; const saved=ord.order||[];
  designs.sort((a,b)=>{const ia=saved.indexOf(a.designKey), ib=saved.indexOf(b.designKey); return (ia==-1?9999:ia)-(ib==-1?9999:ib) || a.name.localeCompare(b.name);});
  list.innerHTML=''; designs.forEach(d=>{
    const li=document.createElement('li'); li.className='order-item'; li.draggable=true; li.dataset.designKey=d.designKey;
    li.innerHTML=`<div class="order-handle"></div><img src="assets/images/${d.img}" style="width:48px"><div>${d.name}</div><div style="margin-left:auto">${d.material}</div>`;
    addDragEvents(li); list.appendChild(li);
  });
}
document.getElementById('reloadOrder').addEventListener('click', buildOrderList);
document.getElementById('saveOrder').addEventListener('click', async()=>{
  const slug=document.getElementById('orderSection').value;
  const order=[...document.querySelectorAll('#orderList .order-item')].map(li=>li.dataset.designKey);
  await fetch(ORDER_API,{method:'PUT',headers:{'Content-Type':'application/json'},credentials:'include',body:JSON.stringify({category:slug,order})});
  alert('Order saved');
});
function addDragEvents(el){
  el.addEventListener('dragstart',e=>{el.classList.add('dragging');});
  el.addEventListener('dragend',()=>el.classList.remove('dragging'));
}
document.getElementById('orderList').addEventListener('dragover',e=>{
  e.preventDefault(); const dragging=document.querySelector('.dragging'); if(!dragging)return;
  const after=getDragAfterElement(e.currentTarget,e.clientY); if(!after) e.currentTarget.appendChild(dragging); else e.currentTarget.insertBefore(dragging,after);
});
function getDragAfterElement(container,y){
  const els=[...container.querySelectorAll('.order-item:not(.dragging)')];
  return els.reduce((closest,child)=>{const box=child.getBoundingClientRect(); const offset=y-box.top-box.height/2; return offset<0&&offset>closest.offset?{offset,element:child}:closest;},{offset:-Infinity}).element;
}
</script>
</body>
</html>